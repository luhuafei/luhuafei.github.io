<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/1.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="IOS," />










<meta name="description" content="##è¿™ä¹Ÿæ˜¯ä¸€ä¸ªiosæµ‹è¯•07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017å¹´ LH">
<meta name="keywords" content="IOS">
<meta property="og:type" content="article">
<meta property="og:title" content="æµ‹è¯•2">
<meta property="og:url" content="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/æµ‹è¯•2/index.html">
<meta property="og:site_name" content="LHFçš„ç½‘ç«™">
<meta property="og:description" content="##è¿™ä¹Ÿæ˜¯ä¸€ä¸ªiosæµ‹è¯•07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017å¹´ LH">
<meta property="og:updated_time" content="2017-11-07T06:39:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æµ‹è¯•2">
<meta name="twitter:description" content="##è¿™ä¹Ÿæ˜¯ä¸€ä¸ªiosæµ‹è¯•07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017å¹´ LH">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/æµ‹è¯•2/"/>





  <title>æµ‹è¯•2 | LHFçš„ç½‘ç«™</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LHFçš„ç½‘ç«™</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">åšå®¢</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/æµ‹è¯•2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="luhuafei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LHFçš„ç½‘ç«™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æµ‹è¯•2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">VerÃ¶ffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-07T10:14:51+08:00">
                2017-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>##è¿™ä¹Ÿæ˜¯ä¸€ä¸ªiosæµ‹è¯•07</p>
<p>//  weibo: <a href="http://weibo.com/xiaoqing28" target="_blank" rel="external">http://weibo.com/xiaoqing28</a><br>//  blog:  <a href="http://www.alonemonkey.com" target="_blank" rel="external">http://www.alonemonkey.com</a><br>//<br>//  MonkeyTestDylib.m<br>//  MonkeyTestDylib<br>//<br>//  Created by DengTianran on 2017/7/28.<br>//  Copyright (c) 2017å¹´ LHF. All rights reserved.<br>//<br>;</p>
<p>#import â€œMonkeyTestDylib.hâ€</p>
<p>#import â€œCaptainHook.hâ€</p>
<p>#import <uikit uikit.h=""></uikit></p>
<p>#import <cycript cycript.h=""></cycript></p>
<p>#import <objc runtime.h=""></objc></p>
<p>#import <objc message.h=""></objc></p>
<p>#import <foundation nsobject.h=""></foundation></p>
<p>#import <foundation nsobjcruntime.h=""></foundation></p>
<p>#import <foundation foundation.h=""></foundation></p>
<p>/**</p>
<ul>
<li>æ’ä»¶åŠŸèƒ½<br>*/<br>static int const kCloseRedEnvPlugin = 0;<br>static int const kOpenRedEnvPlugin = 1;<br>static int const kCloseRedEnvPluginForMyself = 2;<br>static int const kCloseRedEnvPluginForMyselfFromChatroom = 3;</li>
</ul>
<p>//0ï¼šå…³é—­çº¢åŒ…æ’ä»¶<br>//1ï¼šæ‰“å¼€çº¢åŒ…æ’ä»¶<br>//2: ä¸æŠ¢è‡ªå·±çš„çº¢åŒ…<br>//3: ä¸æŠ¢ç¾¤é‡Œè‡ªå·±å‘çš„çº¢åŒ…<br>static int HBPliginType = 0;</p>
<p>static int stepCount = 1234;<br>static NSString <em>WeRunStepKey = @â€WeRunStepKeyâ€;<br>static NSString </em>WeRunSettingFile = @â€WeRunSettingFile.txtâ€;<br>static NSString <em>HBPluginTypeKey = @â€HBPluginTypeâ€;<br>static NSString </em>HBPluginSettingFile = @â€HBPluginSettingFile.txtâ€;<br>/<em>* å¾®ä¿¡å¤´æ–‡ä»¶</em>/</p>
<p>#import â€œCMessageWrap.hâ€</p>
<p>#import â€œCMessageMgr.hâ€</p>
<p>#define SAVESETTINGS(key, value, fileName) { \<br>NSArray <em>paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES); \<br>NSString </em>docDir = [paths objectAtIndex:0]; \<br>if (!docDir){ return;} \<br>NSMutableDictionary <em>dict = [NSMutableDictionary dictionary]; \<br>NSString </em>path = [docDir stringByAppendingPathComponent:fileName]; \<br>[dict setObject:value forKey:key]; \<br>[dict writeToFile:path atomically:YES]; \<br>}</p>
<p>static BOOL isReceivedHB;<br>/<em>* å‘é€æ‰“å¼€è¯·æ±‚å‚æ•°</em>/<br>static NSMutableDictionary <em>parameDIctionary = nil;<br>void initCycriptServer(){<br>[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification </em> _Nonnull note) {</p>
<p>CYListenServer(6666);<br>}];<br>}</p>
<p>static <strong>attribute</strong>((constructor)) void entry(){<br>NSLog(@â€\n               ğŸ‰!!ï¼congratulations!!ï¼ğŸ‰\nğŸ‘â€”â€”â€”â€”â€”-insert dylib successâ€”â€”â€”â€”â€”-ğŸ‘â€);</p>
<p>initCycriptServer();<br>}</p>
<p>/<strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong>çº¢åŒ…è‡ªåŠ¨<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/<br>@interface SKBuiltinBuffer_t</p>
<p>@property(retain, nonatomic) NSData *buffer; // @dynamic buffer;</p>
<p>@end</p>
<p>@interface HongBaoRes</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *retText; // @dynamic retText;<br>@property(nonatomic) int cgiCmdid; // @dynamic cgiCmdid;</p>
<p>@end</p>
<p>@interface HongBaoReq</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *reqText; // @dynamic reqText;</p>
<p>@end<br>CHDeclareClass(CMessageMgr);</p>
<p>CHMethod(2, void, CMessageMgr, AsyncOnAddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CHSuper(2, CMessageMgr, AsyncOnAddMsg, arg1, MsgWrap, arg2);<br>Ivar uiMessageTypeIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_uiMessageTypeâ€);<br>ptrdiff_t offset = ivar_getOffset(uiMessageTypeIvar);<br>unsigned char <em>stuffBytes = (unsigned char </em>)(__bridge void <em>)arg2;<br>NSUInteger m_uiMessageType = </em> ((NSUInteger *)(stuffBytes + offset));</p>
<p>Ivar nsFromUsrIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_nsFromUsrâ€);<br>id m_nsFromUsr = object_getIvar(arg2, nsFromUsrIvar);</p>
<p>Ivar nsContentIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_nsContentâ€);<br>id m_nsContent = object_getIvar(arg2, nsContentIvar);</p>
<p>switch(m_uiMessageType) {<br>case 1:<br>{</p>
<p>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((<strong>bridge void <em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));<br>//é€šè®¯å½•ç®¡ç†å™¨<br>id contactManager = ((id (*)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œCContactMgrâ€));<br>send_type func = (send_type)objc_msgSend;<br>id selfContact = func((</strong>bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], â€œm_nsUsrNameâ€);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>//å‘ç»™è‡ªå·±çš„æ¶ˆæ¯<br>isMesasgeFromMe = YES;<br>}</p>
<p>if (isMesasgeFromMe)<br>{<br>if ([m_nsContent rangeOfString:@â€æ‰“å¼€çº¢åŒ…æ’ä»¶â€].location != NSNotFound)<br>{<br>HBPliginType = kOpenRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­çº¢åŒ…æ’ä»¶â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­æŠ¢è‡ªå·±çº¢åŒ…â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyself;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­æŠ¢è‡ªå·±ç¾¤çº¢åŒ…â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyselfFromChatroom;<br>}else if ([m_nsContent rangeOfString:@â€ä¿®æ”¹å¾®ä¿¡æ­¥æ•°#â€].location != NSNotFound)<br>{<br>NSArray <em>array = [m_nsContent componentsSeparatedByString:@â€#â€];<br>if (array.count == 2) {<br>stepCount = ((NSNumber </em>)array[1]).intValue;<br>}<br>} else if([m_nsContent rangeOfString:@â€æ¢å¤å¾®ä¿¡æ­¥æ•°â€].location != NSNotFound) {<br>stepCount = -1;<br>}<br>SAVESETTINGS(WeRunStepKey, [NSNumber numberWithInt:stepCount], WeRunSettingFile)</p>
<p>SAVESETTINGS(HBPluginTypeKey, [NSNumber numberWithInt:HBPliginType], HBPluginSettingFile);<br>}<br>}<br>break;<br>case 49: {</p>
<p>NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>NSMutableDictionary </em>dict = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:HBPluginSettingFile]];<br>if (dict){<br>HBPliginType = ((NSNumber <em>)dict[HBPluginTypeKey]).intValue;<br>}<br>// 49=çº¢åŒ…<br>//å¾®ä¿¡çš„æœåŠ¡ä¸­å¿ƒ<br>typedef id (</em>send_type)(void<em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void </em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>//çº¢åŒ…æ§åˆ¶å™¨<br>id logicMgr = ((id (<em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));<br>//é€šè®¯å½•ç®¡ç†å™¨<br>id contactManager = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œCContactMgrâ€));</p>
<p>Method methodGetSelfContact = class_getInstanceMethod(objc_getClass(â€œCContactMgrâ€), @selector(getSelfContact));<br>send_type impGS = (send_type)method_getImplementation(methodGetSelfContact);<br>id selfContact = impGS((__bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], â€œm_nsUsrNameâ€);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>BOOL isChatroom = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>isMesasgeFromMe = YES;<br>}<br>if ([m_nsFromUsr rangeOfString:@â€@chatroomâ€].location != NSNotFound)<br>{<br>isChatroom = YES;<br>}<br>if (isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyself == HBPliginType &amp;&amp; !isChatroom) {<br>//ä¸æŠ¢è‡ªå·±çš„çº¢åŒ…<br>break;<br>}<br>else if(isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyselfFromChatroom == HBPliginType &amp;&amp; isChatroom)<br>{<br>//ä¸æŠ¢ç¾¤é‡Œè‡ªå·±çš„çº¢åŒ…<br>break;<br>}</p>
<p>if ([m_nsContent rangeOfString:@â€wxpay://â€œ].location != NSNotFound)<br>{<br>NSString *nativeUrl = m_nsContent;<br>NSRange rangeStart = [m_nsContent rangeOfString:@â€wxpay://c2cbizmessagehandler/hongbaoâ€];<br>if (rangeStart.location != NSNotFound)<br>{<br>NSUInteger locationStart = rangeStart.location;<br>nativeUrl = [nativeUrl substringFromIndex:locationStart];<br>}</p>
<p>NSRange rangeEnd = [nativeUrl rangeOfString:@â€]]â€];<br>if (rangeEnd.location != NSNotFound)<br>{<br>NSUInteger locationEnd = rangeEnd.location;<br>nativeUrl = [nativeUrl substringToIndex:locationEnd];<br>}</p>
<p>NSString *naUrl = [nativeUrl substringFromIndex:[@â€wxpay://c2cbizmessagehandler/hongbao/receivehongbao?â€ length]];</p>
<p>NSArray *parameterPairs =[naUrl componentsSeparatedByString:@â€&amp;â€];</p>
<p>NSMutableDictionary <em>parameters = [NSMutableDictionary dictionaryWithCapacity:[parameterPairs count]];<br>for (NSString </em>currentPair in parameterPairs) {<br>NSRange range = [currentPair rangeOfString:@â€=â€];<br>if(range.location == NSNotFound)<br>continue;<br>NSString <em>key = [currentPair substringToIndex:range.location];<br>NSString </em>value =[currentPair substringFromIndex:range.location + 1];<br>[parameters setObject:value forKey:key];<br>}</p>
<p>//çº¢åŒ…å‚æ•°<br>NSMutableDictionary <em>params = [@{} mutableCopy];<br>[params setObject:parameters[@â€msgtypeâ€]?:@â€nullâ€ forKey:@â€msgTypeâ€];<br>[params setObject:parameters[@â€sendidâ€]?:@â€nullâ€ forKey:@â€sendIdâ€];<br>[params setObject:parameters[@â€channelidâ€]?:@â€nullâ€ forKey:@â€channelIdâ€];<br>typedef id (</em>objc_type)(void*, SEL);<br>objc_type func = (objc_type)objc_msgSend;</p>
<p>id getContactDisplayName = func((<strong>bridge void *)(selfContact), @selector(getContactDisplayName));<br>id m_nsHeadImgUrl = func((</strong>bridge void *)(selfContact), @selector(m_nsHeadImgUrl));</p>
<p>[params setObject:getContactDisplayName forKey:@â€nickNameâ€];<br>[params setObject:m_nsHeadImgUrl forKey:@â€headImgâ€];<br>[params setObject:[NSString stringWithFormat:@â€%@â€, nativeUrl]?:@â€nullâ€ forKey:@â€nativeUrlâ€];<br>[params setObject:m_nsFromUsr?:@â€nullâ€ forKey:@â€sessionUserNameâ€];<br>parameDIctionary = [params mutableCopy];</p>
<p>//è®¾ç½®çº¢åŒ…æ²¡æœ‰é¢†å–<br>isReceivedHB = NO;</p>
<p>if (kCloseRedEnvPlugin != HBPliginType) {<br>//è‡ªåŠ¨æŠ¢çº¢åŒ…<br>//å‘é€çº¢åŒ…éªŒè¯è¯·æ±‚<br>((void (*)(id, SEL, id))objc_msgSend)(logicMgr, @selector(ReceiverQueryRedEnvelopesRequest:), params);</p>
<p>}<br>return;<br>}</p>
<p>break;<br>}<br>default:<br>break;<br>}<br>}</p>
<p>CHDeclareClass(WCRedEnvelopesLogicMgr);<br>CHMethod(2, void, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,id, arg1,Request, id, arg2 )<br>{</p>
<p>CHSuper(2, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,arg1,Request,arg2 );</p>
<p>//å¦‚æœé¢†å–å°±ä¸å†å‘é€æ¶ˆæ¯<br>if (isReceivedHB) {<br>return;<br>}<br>HongBaoRes *obj=arg1;</p>
<p>if(obj.cgiCmdid != 3) return;<br>NSLog(@â€parameDIctionary === %@â€, parameDIctionary);<br>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void <em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));</p>
<p>NSDictionary * dictionary= [NSJSONSerialization JSONObjectWithData:obj.retText.buffer options:NSJSONReadingMutableContainers error:nil];</p>
<p>if ([dictionary[@â€receiveStatusâ€] integerValue] == 2) { return; }<br>if ([dictionary[@â€hbStatusâ€] integerValue] == 4) { return; }<br>//é˜²æ­¢æœºå™¨å¤–æŒ‚åˆ·<br>if (!dictionary[@â€timingIdentifierâ€]) {<br>return;<br>}</p>
<p>[parameDIctionary setObject:dictionary[@â€timingIdentifierâ€]?:@â€nullâ€ forKey:@â€timingIdentifierâ€];<br>NSUInteger randomSeconds = arc4random_uniform(3);<br>dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(randomSeconds <em> NSEC_PER_SEC)), dispatch_get_main_queue(), ^{<br>((void (</em>)(id, SEL, NSMutableDictionary*))objc_msgSend)(logicMgr, @selector(OpenRedEnvelopesRequest:), parameDIctionary);<br>parameDIctionary = nil;<br>isReceivedHB = YES;<br>});<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>æ¶ˆæ¯å…æ’¤å›<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>CHDeclareClass(CMessageMgr);<br>CHOptimizedMethod(1, self, void, CMessageMgr, onRevokeMsg, CMessageWrap *, arg1){</p>
<p>if ([arg1.m_nsContent rangeOfString:@â€<session>â€œ].location == NSNotFound) { return; }<br>if ([arg1.m_nsContent rangeOfString:@â€<replacemsg>â€œ].location == NSNotFound) { return; }</replacemsg></session></p>
<p>NSString <em>(^parseSession)() = ^NSString </em>() {<br>NSUInteger startIndex = [arg1.m_nsContent rangeOfString:@â€<session>â€œ].location + @â€<session>â€œ.length;<br>NSUInteger endIndex = [arg1.m_nsContent rangeOfString:@â€</session>â€œ].location;<br>NSRange range = NSMakeRange(startIndex, endIndex - startIndex);<br>return [arg1.m_nsContent substringWithRange:range];<br>};</session></p>
<p>NSString <em>(^parseSenderName)() = ^NSString </em>() {<br>NSRegularExpression <em>regex = [NSRegularExpression regularExpressionWithPattern:@â€&lt;!\[CDATA\[(.</em>?)æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯\]\]&gt;â€ options:NSRegularExpressionCaseInsensitive error:nil];</p>
<p>NSRange range = NSMakeRange(0, arg1.m_nsContent.length);<br>NSTextCheckingResult *result = [regex matchesInString:arg1.m_nsContent options:0 range:range].firstObject;<br>if (result.numberOfRanges &lt; 2) { return nil; }</p>
<p>return [arg1.m_nsContent substringWithRange:[result rangeAtIndex:1]];<br>};</p>
<p>CMessageWrap *msgWrap = [[objc_getClass(â€œCMessageWrapâ€) alloc] initWithMsgType:0x2710];<br>BOOL isSender = [objc_getClass(â€œCMessageWrapâ€) isSenderFromMsgWrap:arg1];</p>
<p>NSString *sendContent;<br>if (isSender) {<br>[msgWrap setM_nsFromUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsToUsr:arg1.m_nsFromUsr];<br>sendContent = @â€ä½ æ’¤å›ä¸€æ¡æ¶ˆæ¯â€;<br>} else {<br>[msgWrap setM_nsToUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsFromUsr:arg1.m_nsFromUsr];</p>
<p>NSString *name = parseSenderName();<br>sendContent = [NSString stringWithFormat:@â€æ‹¦æˆª %@ çš„ä¸€æ¡æ’¤å›æ¶ˆæ¯â€, name ? name : arg1.m_nsFromUsr];<br>}<br>[msgWrap setM_uiStatus:0x4];<br>[msgWrap setM_nsContent:sendContent];<br>[msgWrap setM_uiCreateTime:[arg1 m_uiCreateTime]];</p>
<p>[self AddLocalMsg:parseSession() MsgWrap:msgWrap fixTime:0x1 NewMsgArriveNotify:0x0];<br>}</p>
<p>/<strong><strong><strong><strong><em>*</em></strong></strong></strong></strong>å¾®ä¿¡è®¡æ•°æ­¥æ•°<strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>//æ­¥æ•°å¤šå°‘åœ¨æ”¶å‘æ¶ˆæ¯é‡Œè®¾ç½®<br>CHDeclareClass(WCDeviceStepObject);<br>CHMethod0(unsigned int, WCDeviceStepObject, m7StepCount) {<br>//    NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>//    NSMutableDictionary </em>dic = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:WeRunSettingFile]];<br>//    if (!dic){ return stepCount;}<br>//    int value = ((NSNumber *)dic[WeRunStepKey]).intValue;<br>//    if (value &lt; 0) {<br>//        return CHSuper(0, WCDeviceStepObject, m7StepCount);<br>//    }<br>return stepCount;<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>@æ‰€æœ‰äºº<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>@interface CContact</p>
<p>@property (copy, nonatomic)NSString *m_nsUsrName;</p>
<ul>
<li>(NSArray *)getChatRoomMemberWithoutMyself:(id)arg;<br>@end</li>
</ul>
<p>@interface CContactMgr</p>
<ul>
<li>(id)getSelfContact;</li>
</ul>
<ul>
<li>(id)class;</li>
</ul>
<p>@end</p>
<p>@interface MMServiceCenter</p>
<ul>
<li>(id)getService:(id)arg;<br>+(id)defaultCenter;<br>@end<br>CHDeclareClass(CMessageMgr);</li>
</ul>
<p>CHMethod(2, void, CMessageMgr, AddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CMessageWrap <em>wrap = arg2;<br>CContactMgr </em>ccMgr = [[objc_getClass(â€œMMServiceCenterâ€) defaultCenter] getService:[objc_getClass(â€œCContactMgrâ€) class]];<br>CContact <em>contact = [ccMgr getSelfContact];<br>if (wrap.m_uiMessageType == 1) {<br>if (wrap.m_nsFromUsr == contact.m_nsUsrName) {<br>if (wrap.m_nsMsgSource == nil) {<br>NSArray </em>contactArray = [objc_getClass(â€œCContactâ€) getChatRoomMemberWithoutMyself:wrap.m_nsToUsr];<br>if ([wrap.m_nsContent hasPrefix:@â€allâ€]) {<br>NSString <em>subStr = [wrap.m_nsContent substringFromIndex:3];<br>NSMutableString </em>string = [NSMutableString string];</p>
<p>[contactArray enumerateObjectsUsingBlock:^(CContact <em>obj, NSUInteger idx, BOOL </em> _Nonnull stop) {</p>
<p>[string appendFormat:@â€,%@â€,obj.m_nsUsrName];<br>}];<br>NSString *sourceString = nil;</p>
<p>//å¦‚æœresult.count &gt; 0ä»£è¡¨æ˜¯è°ç¾¤èŠ, å¦åˆ™æ˜¯å•èŠ<br>if (contactArray.count &gt; 0) {<br>sourceString = [string substringFromIndex:1];<br>}else<br>{<br>sourceString = wrap.m_nsToUsr;<br>}<br>wrap.m_uiStatus = 3;<br>wrap.m_nsContent = subStr;<br>wrap.m_nsMsgSource = [NSString stringWithFormat:@â€<msgsource><atuserlist>%@</atuserlist></msgsource>â€œ,sourceString];<br>}<br>}<br>}</p>
<p>}</p>
<p>CHSuper(2, CMessageMgr, AddMsg, arg1, MsgWrap, arg2);</p>
<p>}</p>
<p>CHConstructor{<br>@autoreleasepool<br>{<br>//åŠ è½½CMessageMgrç±»<br>CHLoadLateClass(CMessageMgr);<br>//@æ‰€æœ‰äºº<br>CHClassHook(2, CMessageMgr, AddMsg, MsgWrap);</p>
<p>CHClassHook(2, CMessageMgr, AsyncOnAddMsg, MsgWrap);<br>CHLoadLateClass(WCRedEnvelopesLogicMgr);<br>CHClassHook(2, WCRedEnvelopesLogicMgr, OnWCToHongbaoCommonResponse, Request);</p>
<p>//æ¶ˆæ¯å…æ’¤å›<br>CHHook(1, CMessageMgr, onRevokeMsg);</p>
<p>//æ­¥æ•°<br>CHLoadLateClass(WCDeviceStepObject);<br>CHHook0(WCDeviceStepObject, m7StepCount);<br>}</p>
<p>}</p>
<p>//  weibo: <a href="http://weibo.com/xiaoqing28" target="_blank" rel="external">http://weibo.com/xiaoqing28</a><br>//  blog:  <a href="http://www.alonemonkey.com" target="_blank" rel="external">http://www.alonemonkey.com</a><br>//<br>//  MonkeyTestDylib.m<br>//  MonkeyTestDylib<br>//<br>//  Created by DengTianran on 2017/7/28.<br>//  Copyright (c) 2017å¹´ LHF. All rights reserved.<br>//<br>;</p>
<p>#import â€œMonkeyTestDylib.hâ€</p>
<p>#import â€œCaptainHook.hâ€</p>
<p>#import <uikit uikit.h=""></uikit></p>
<p>#import <cycript cycript.h=""></cycript></p>
<p>#import <objc runtime.h=""></objc></p>
<p>#import <objc message.h=""></objc></p>
<p>#import <foundation nsobject.h=""></foundation></p>
<p>#import <foundation nsobjcruntime.h=""></foundation></p>
<p>#import <foundation foundation.h=""></foundation></p>
<p>/**</p>
<ul>
<li>æ’ä»¶åŠŸèƒ½<br>*/<br>static int const kCloseRedEnvPlugin = 0;<br>static int const kOpenRedEnvPlugin = 1;<br>static int const kCloseRedEnvPluginForMyself = 2;<br>static int const kCloseRedEnvPluginForMyselfFromChatroom = 3;</li>
</ul>
<p>//0ï¼šå…³é—­çº¢åŒ…æ’ä»¶<br>//1ï¼šæ‰“å¼€çº¢åŒ…æ’ä»¶<br>//2: ä¸æŠ¢è‡ªå·±çš„çº¢åŒ…<br>//3: ä¸æŠ¢ç¾¤é‡Œè‡ªå·±å‘çš„çº¢åŒ…<br>static int HBPliginType = 0;</p>
<p>static int stepCount = 1234;<br>static NSString <em>WeRunStepKey = @â€WeRunStepKeyâ€;<br>static NSString </em>WeRunSettingFile = @â€WeRunSettingFile.txtâ€;<br>static NSString <em>HBPluginTypeKey = @â€HBPluginTypeâ€;<br>static NSString </em>HBPluginSettingFile = @â€HBPluginSettingFile.txtâ€;<br>/<em>* å¾®ä¿¡å¤´æ–‡ä»¶</em>/</p>
<p>#import â€œCMessageWrap.hâ€</p>
<p>#import â€œCMessageMgr.hâ€</p>
<p>#define SAVESETTINGS(key, value, fileName) { \<br>NSArray <em>paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES); \<br>NSString </em>docDir = [paths objectAtIndex:0]; \<br>if (!docDir){ return;} \<br>NSMutableDictionary <em>dict = [NSMutableDictionary dictionary]; \<br>NSString </em>path = [docDir stringByAppendingPathComponent:fileName]; \<br>[dict setObject:value forKey:key]; \<br>[dict writeToFile:path atomically:YES]; \<br>}</p>
<p>static BOOL isReceivedHB;<br>/<em>* å‘é€æ‰“å¼€è¯·æ±‚å‚æ•°</em>/<br>static NSMutableDictionary <em>parameDIctionary = nil;<br>void initCycriptServer(){<br>[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification </em> _Nonnull note) {</p>
<p>CYListenServer(6666);<br>}];<br>}</p>
<p>static <strong>attribute</strong>((constructor)) void entry(){<br>NSLog(@â€\n               ğŸ‰!!ï¼congratulations!!ï¼ğŸ‰\nğŸ‘â€”â€”â€”â€”â€”-insert dylib successâ€”â€”â€”â€”â€”-ğŸ‘â€);</p>
<p>initCycriptServer();<br>}</p>
<p>/<strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong>çº¢åŒ…è‡ªåŠ¨<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/<br>@interface SKBuiltinBuffer_t</p>
<p>@property(retain, nonatomic) NSData *buffer; // @dynamic buffer;</p>
<p>@end</p>
<p>@interface HongBaoRes</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *retText; // @dynamic retText;<br>@property(nonatomic) int cgiCmdid; // @dynamic cgiCmdid;</p>
<p>@end</p>
<p>@interface HongBaoReq</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *reqText; // @dynamic reqText;</p>
<p>@end<br>CHDeclareClass(CMessageMgr);</p>
<p>CHMethod(2, void, CMessageMgr, AsyncOnAddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CHSuper(2, CMessageMgr, AsyncOnAddMsg, arg1, MsgWrap, arg2);<br>Ivar uiMessageTypeIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_uiMessageTypeâ€);<br>ptrdiff_t offset = ivar_getOffset(uiMessageTypeIvar);<br>unsigned char <em>stuffBytes = (unsigned char </em>)(__bridge void <em>)arg2;<br>NSUInteger m_uiMessageType = </em> ((NSUInteger *)(stuffBytes + offset));</p>
<p>Ivar nsFromUsrIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_nsFromUsrâ€);<br>id m_nsFromUsr = object_getIvar(arg2, nsFromUsrIvar);</p>
<p>Ivar nsContentIvar = class_getInstanceVariable(objc_getClass(â€œCMessageWrapâ€), â€œm_nsContentâ€);<br>id m_nsContent = object_getIvar(arg2, nsContentIvar);</p>
<p>switch(m_uiMessageType) {<br>case 1:<br>{</p>
<p>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((<strong>bridge void <em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));<br>//é€šè®¯å½•ç®¡ç†å™¨<br>id contactManager = ((id (*)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œCContactMgrâ€));<br>send_type func = (send_type)objc_msgSend;<br>id selfContact = func((</strong>bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], â€œm_nsUsrNameâ€);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>//å‘ç»™è‡ªå·±çš„æ¶ˆæ¯<br>isMesasgeFromMe = YES;<br>}</p>
<p>if (isMesasgeFromMe)<br>{<br>if ([m_nsContent rangeOfString:@â€æ‰“å¼€çº¢åŒ…æ’ä»¶â€].location != NSNotFound)<br>{<br>HBPliginType = kOpenRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­çº¢åŒ…æ’ä»¶â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­æŠ¢è‡ªå·±çº¢åŒ…â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyself;<br>}<br>else if ([m_nsContent rangeOfString:@â€å…³é—­æŠ¢è‡ªå·±ç¾¤çº¢åŒ…â€].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyselfFromChatroom;<br>}else if ([m_nsContent rangeOfString:@â€ä¿®æ”¹å¾®ä¿¡æ­¥æ•°#â€].location != NSNotFound)<br>{<br>NSArray <em>array = [m_nsContent componentsSeparatedByString:@â€#â€];<br>if (array.count == 2) {<br>stepCount = ((NSNumber </em>)array[1]).intValue;<br>}<br>} else if([m_nsContent rangeOfString:@â€æ¢å¤å¾®ä¿¡æ­¥æ•°â€].location != NSNotFound) {<br>stepCount = -1;<br>}<br>SAVESETTINGS(WeRunStepKey, [NSNumber numberWithInt:stepCount], WeRunSettingFile)</p>
<p>SAVESETTINGS(HBPluginTypeKey, [NSNumber numberWithInt:HBPliginType], HBPluginSettingFile);<br>}<br>}<br>break;<br>case 49: {</p>
<p>NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>NSMutableDictionary </em>dict = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:HBPluginSettingFile]];<br>if (dict){<br>HBPliginType = ((NSNumber <em>)dict[HBPluginTypeKey]).intValue;<br>}<br>// 49=çº¢åŒ…<br>//å¾®ä¿¡çš„æœåŠ¡ä¸­å¿ƒ<br>typedef id (</em>send_type)(void<em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void </em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>//çº¢åŒ…æ§åˆ¶å™¨<br>id logicMgr = ((id (<em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));<br>//é€šè®¯å½•ç®¡ç†å™¨<br>id contactManager = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œCContactMgrâ€));</p>
<p>Method methodGetSelfContact = class_getInstanceMethod(objc_getClass(â€œCContactMgrâ€), @selector(getSelfContact));<br>send_type impGS = (send_type)method_getImplementation(methodGetSelfContact);<br>id selfContact = impGS((__bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], â€œm_nsUsrNameâ€);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>BOOL isChatroom = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>isMesasgeFromMe = YES;<br>}<br>if ([m_nsFromUsr rangeOfString:@â€@chatroomâ€].location != NSNotFound)<br>{<br>isChatroom = YES;<br>}<br>if (isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyself == HBPliginType &amp;&amp; !isChatroom) {<br>//ä¸æŠ¢è‡ªå·±çš„çº¢åŒ…<br>break;<br>}<br>else if(isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyselfFromChatroom == HBPliginType &amp;&amp; isChatroom)<br>{<br>//ä¸æŠ¢ç¾¤é‡Œè‡ªå·±çš„çº¢åŒ…<br>break;<br>}</p>
<p>if ([m_nsContent rangeOfString:@â€wxpay://â€œ].location != NSNotFound)<br>{<br>NSString *nativeUrl = m_nsContent;<br>NSRange rangeStart = [m_nsContent rangeOfString:@â€wxpay://c2cbizmessagehandler/hongbaoâ€];<br>if (rangeStart.location != NSNotFound)<br>{<br>NSUInteger locationStart = rangeStart.location;<br>nativeUrl = [nativeUrl substringFromIndex:locationStart];<br>}</p>
<p>NSRange rangeEnd = [nativeUrl rangeOfString:@â€]]â€];<br>if (rangeEnd.location != NSNotFound)<br>{<br>NSUInteger locationEnd = rangeEnd.location;<br>nativeUrl = [nativeUrl substringToIndex:locationEnd];<br>}</p>
<p>NSString *naUrl = [nativeUrl substringFromIndex:[@â€wxpay://c2cbizmessagehandler/hongbao/receivehongbao?â€ length]];</p>
<p>NSArray *parameterPairs =[naUrl componentsSeparatedByString:@â€&amp;â€];</p>
<p>NSMutableDictionary <em>parameters = [NSMutableDictionary dictionaryWithCapacity:[parameterPairs count]];<br>for (NSString </em>currentPair in parameterPairs) {<br>NSRange range = [currentPair rangeOfString:@â€=â€];<br>if(range.location == NSNotFound)<br>continue;<br>NSString <em>key = [currentPair substringToIndex:range.location];<br>NSString </em>value =[currentPair substringFromIndex:range.location + 1];<br>[parameters setObject:value forKey:key];<br>}</p>
<p>//çº¢åŒ…å‚æ•°<br>NSMutableDictionary <em>params = [@{} mutableCopy];<br>[params setObject:parameters[@â€msgtypeâ€]?:@â€nullâ€ forKey:@â€msgTypeâ€];<br>[params setObject:parameters[@â€sendidâ€]?:@â€nullâ€ forKey:@â€sendIdâ€];<br>[params setObject:parameters[@â€channelidâ€]?:@â€nullâ€ forKey:@â€channelIdâ€];<br>typedef id (</em>objc_type)(void*, SEL);<br>objc_type func = (objc_type)objc_msgSend;</p>
<p>id getContactDisplayName = func((<strong>bridge void *)(selfContact), @selector(getContactDisplayName));<br>id m_nsHeadImgUrl = func((</strong>bridge void *)(selfContact), @selector(m_nsHeadImgUrl));</p>
<p>[params setObject:getContactDisplayName forKey:@â€nickNameâ€];<br>[params setObject:m_nsHeadImgUrl forKey:@â€headImgâ€];<br>[params setObject:[NSString stringWithFormat:@â€%@â€, nativeUrl]?:@â€nullâ€ forKey:@â€nativeUrlâ€];<br>[params setObject:m_nsFromUsr?:@â€nullâ€ forKey:@â€sessionUserNameâ€];<br>parameDIctionary = [params mutableCopy];</p>
<p>//è®¾ç½®çº¢åŒ…æ²¡æœ‰é¢†å–<br>isReceivedHB = NO;</p>
<p>if (kCloseRedEnvPlugin != HBPliginType) {<br>//è‡ªåŠ¨æŠ¢çº¢åŒ…<br>//å‘é€çº¢åŒ…éªŒè¯è¯·æ±‚<br>((void (*)(id, SEL, id))objc_msgSend)(logicMgr, @selector(ReceiverQueryRedEnvelopesRequest:), params);</p>
<p>}<br>return;<br>}</p>
<p>break;<br>}<br>default:<br>break;<br>}<br>}</p>
<p>CHDeclareClass(WCRedEnvelopesLogicMgr);<br>CHMethod(2, void, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,id, arg1,Request, id, arg2 )<br>{</p>
<p>CHSuper(2, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,arg1,Request,arg2 );</p>
<p>//å¦‚æœé¢†å–å°±ä¸å†å‘é€æ¶ˆæ¯<br>if (isReceivedHB) {<br>return;<br>}<br>HongBaoRes *obj=arg1;</p>
<p>if(obj.cgiCmdid != 3) return;<br>NSLog(@â€parameDIctionary === %@â€, parameDIctionary);<br>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(â€œMMServiceCenterâ€), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void <em>)(objc_getClass(â€œMMServiceCenterâ€)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(â€œWCRedEnvelopesLogicMgrâ€));</p>
<p>NSDictionary * dictionary= [NSJSONSerialization JSONObjectWithData:obj.retText.buffer options:NSJSONReadingMutableContainers error:nil];</p>
<p>if ([dictionary[@â€receiveStatusâ€] integerValue] == 2) { return; }<br>if ([dictionary[@â€hbStatusâ€] integerValue] == 4) { return; }<br>//é˜²æ­¢æœºå™¨å¤–æŒ‚åˆ·<br>if (!dictionary[@â€timingIdentifierâ€]) {<br>return;<br>}</p>
<p>[parameDIctionary setObject:dictionary[@â€timingIdentifierâ€]?:@â€nullâ€ forKey:@â€timingIdentifierâ€];<br>NSUInteger randomSeconds = arc4random_uniform(3);<br>dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(randomSeconds <em> NSEC_PER_SEC)), dispatch_get_main_queue(), ^{<br>((void (</em>)(id, SEL, NSMutableDictionary*))objc_msgSend)(logicMgr, @selector(OpenRedEnvelopesRequest:), parameDIctionary);<br>parameDIctionary = nil;<br>isReceivedHB = YES;<br>});<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>æ¶ˆæ¯å…æ’¤å›<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>CHDeclareClass(CMessageMgr);<br>CHOptimizedMethod(1, self, void, CMessageMgr, onRevokeMsg, CMessageWrap *, arg1){</p>
<p>if ([arg1.m_nsContent rangeOfString:@â€<session>â€œ].location == NSNotFound) { return; }<br>if ([arg1.m_nsContent rangeOfString:@â€<replacemsg>â€œ].location == NSNotFound) { return; }</replacemsg></session></p>
<p>NSString <em>(^parseSession)() = ^NSString </em>() {<br>NSUInteger startIndex = [arg1.m_nsContent rangeOfString:@â€<session>â€œ].location + @â€<session>â€œ.length;<br>NSUInteger endIndex = [arg1.m_nsContent rangeOfString:@â€</session>â€œ].location;<br>NSRange range = NSMakeRange(startIndex, endIndex - startIndex);<br>return [arg1.m_nsContent substringWithRange:range];<br>};</session></p>
<p>NSString <em>(^parseSenderName)() = ^NSString </em>() {<br>NSRegularExpression <em>regex = [NSRegularExpression regularExpressionWithPattern:@â€&lt;!\[CDATA\[(.</em>?)æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯\]\]&gt;â€ options:NSRegularExpressionCaseInsensitive error:nil];</p>
<p>NSRange range = NSMakeRange(0, arg1.m_nsContent.length);<br>NSTextCheckingResult *result = [regex matchesInString:arg1.m_nsContent options:0 range:range].firstObject;<br>if (result.numberOfRanges &lt; 2) { return nil; }</p>
<p>return [arg1.m_nsContent substringWithRange:[result rangeAtIndex:1]];<br>};</p>
<p>CMessageWrap *msgWrap = [[objc_getClass(â€œCMessageWrapâ€) alloc] initWithMsgType:0x2710];<br>BOOL isSender = [objc_getClass(â€œCMessageWrapâ€) isSenderFromMsgWrap:arg1];</p>
<p>NSString *sendContent;<br>if (isSender) {<br>[msgWrap setM_nsFromUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsToUsr:arg1.m_nsFromUsr];<br>sendContent = @â€ä½ æ’¤å›ä¸€æ¡æ¶ˆæ¯â€;<br>} else {<br>[msgWrap setM_nsToUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsFromUsr:arg1.m_nsFromUsr];</p>
<p>NSString *name = parseSenderName();<br>sendContent = [NSString stringWithFormat:@â€æ‹¦æˆª %@ çš„ä¸€æ¡æ’¤å›æ¶ˆæ¯â€, name ? name : arg1.m_nsFromUsr];<br>}<br>[msgWrap setM_uiStatus:0x4];<br>[msgWrap setM_nsContent:sendContent];<br>[msgWrap setM_uiCreateTime:[arg1 m_uiCreateTime]];</p>
<p>[self AddLocalMsg:parseSession() MsgWrap:msgWrap fixTime:0x1 NewMsgArriveNotify:0x0];<br>}</p>
<p>/<strong><strong><strong><strong><em>*</em></strong></strong></strong></strong>å¾®ä¿¡è®¡æ•°æ­¥æ•°<strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>//æ­¥æ•°å¤šå°‘åœ¨æ”¶å‘æ¶ˆæ¯é‡Œè®¾ç½®<br>CHDeclareClass(WCDeviceStepObject);<br>CHMethod0(unsigned int, WCDeviceStepObject, m7StepCount) {<br>//    NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>//    NSMutableDictionary </em>dic = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:WeRunSettingFile]];<br>//    if (!dic){ return stepCount;}<br>//    int value = ((NSNumber *)dic[WeRunStepKey]).intValue;<br>//    if (value &lt; 0) {<br>//        return CHSuper(0, WCDeviceStepObject, m7StepCount);<br>//    }<br>return stepCount;<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>@æ‰€æœ‰äºº<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>@interface CContact</p>
<p>@property (copy, nonatomic)NSString *m_nsUsrName;</p>
<ul>
<li>(NSArray *)getChatRoomMemberWithoutMyself:(id)arg;<br>@end</li>
</ul>
<p>@interface CContactMgr</p>
<ul>
<li>(id)getSelfContact;</li>
</ul>
<ul>
<li>(id)class;</li>
</ul>
<p>@end</p>
<p>@interface MMServiceCenter</p>
<ul>
<li>(id)getService:(id)arg;<br>+(id)defaultCenter;<br>@end<br>CHDeclareClass(CMessageMgr);</li>
</ul>
<p>CHMethod(2, void, CMessageMgr, AddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CMessageWrap <em>wrap = arg2;<br>CContactMgr </em>ccMgr = [[objc_getClass(â€œMMServiceCenterâ€) defaultCenter] getService:[objc_getClass(â€œCContactMgrâ€) class]];<br>CContact <em>contact = [ccMgr getSelfContact];<br>if (wrap.m_uiMessageType == 1) {<br>if (wrap.m_nsFromUsr == contact.m_nsUsrName) {<br>if (wrap.m_nsMsgSource == nil) {<br>NSArray </em>contactArray = [objc_getClass(â€œCContactâ€) getChatRoomMemberWithoutMyself:wrap.m_nsToUsr];<br>if ([wrap.m_nsContent hasPrefix:@â€allâ€]) {<br>NSString <em>subStr = [wrap.m_nsContent substringFromIndex:3];<br>NSMutableString </em>string = [NSMutableString string];</p>
<p>[contactArray enumerateObjectsUsingBlock:^(CContact <em>obj, NSUInteger idx, BOOL </em> _Nonnull stop) {</p>
<p>[string appendFormat:@â€,%@â€,obj.m_nsUsrName];<br>}];<br>NSString *sourceString = nil;</p>
<p>//å¦‚æœresult.count &gt; 0ä»£è¡¨æ˜¯è°ç¾¤èŠ, å¦åˆ™æ˜¯å•èŠ<br>if (contactArray.count &gt; 0) {<br>sourceString = [string substringFromIndex:1];<br>}else<br>{<br>sourceString = wrap.m_nsToUsr;<br>}<br>wrap.m_uiStatus = 3;<br>wrap.m_nsContent = subStr;<br>wrap.m_nsMsgSource = [NSString stringWithFormat:@â€<msgsource><atuserlist>%@</atuserlist></msgsource>â€œ,sourceString];<br>}<br>}<br>}</p>
<p>}</p>
<p>CHSuper(2, CMessageMgr, AddMsg, arg1, MsgWrap, arg2);</p>
<p>}</p>
<p>CHConstructor{<br>@autoreleasepool<br>{<br>//åŠ è½½CMessageMgrç±»<br>CHLoadLateClass(CMessageMgr);<br>//@æ‰€æœ‰äºº<br>CHClassHook(2, CMessageMgr, AddMsg, MsgWrap);</p>
<p>CHClassHook(2, CMessageMgr, AsyncOnAddMsg, MsgWrap);<br>CHLoadLateClass(WCRedEnvelopesLogicMgr);<br>CHClassHook(2, WCRedEnvelopesLogicMgr, OnWCToHongbaoCommonResponse, Request);</p>
<p>//æ¶ˆæ¯å…æ’¤å›<br>CHHook(1, CMessageMgr, onRevokeMsg);</p>
<p>//æ­¥æ•°<br>CHLoadLateClass(WCDeviceStepObject);<br>CHHook0(WCDeviceStepObject, m7StepCount);<br>}</p>
<p>}</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/IOS/" rel="tag"># IOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/07/æµ‹è¯•/" rel="next" title="æµ‹è¯•">
                <i class="fa fa-chevron-left"></i> æµ‹è¯•
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/07/æµ‹è¯•3/" rel="prev" title="æµ‹è¯•3">
                æµ‹è¯•3 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">luhuafei</p>
              <p class="site-description motion-element" itemprop="description">å­¦ä¹ ç¬”è®°</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luhuafei</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>
