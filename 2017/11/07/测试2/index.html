<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/1.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="IOS," />










<meta name="description" content="##这也是一个ios测试07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017年 LH">
<meta name="keywords" content="IOS">
<meta property="og:type" content="article">
<meta property="og:title" content="测试2">
<meta property="og:url" content="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/测试2/index.html">
<meta property="og:site_name" content="LHF的网站">
<meta property="og:description" content="##这也是一个ios测试07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017年 LH">
<meta property="og:updated_time" content="2017-11-07T06:39:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="测试2">
<meta name="twitter:description" content="##这也是一个ios测试07 //  weibo: http://weibo.com/xiaoqing28//  blog:  http://www.alonemonkey.com////  MonkeyTestDylib.m//  MonkeyTestDylib////  Created by DengTianran on 2017/7/28.//  Copyright (c) 2017年 LH">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/测试2/"/>





  <title>测试2 | LHF的网站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LHF的网站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/luhuafei/luhuafei.github.io.git/2017/11/07/测试2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="luhuafei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LHF的网站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">测试2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-07T10:14:51+08:00">
                2017-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>##这也是一个ios测试07</p>
<p>//  weibo: <a href="http://weibo.com/xiaoqing28" target="_blank" rel="external">http://weibo.com/xiaoqing28</a><br>//  blog:  <a href="http://www.alonemonkey.com" target="_blank" rel="external">http://www.alonemonkey.com</a><br>//<br>//  MonkeyTestDylib.m<br>//  MonkeyTestDylib<br>//<br>//  Created by DengTianran on 2017/7/28.<br>//  Copyright (c) 2017年 LHF. All rights reserved.<br>//<br>;</p>
<p>#import “MonkeyTestDylib.h”</p>
<p>#import “CaptainHook.h”</p>
<p>#import <uikit uikit.h=""></uikit></p>
<p>#import <cycript cycript.h=""></cycript></p>
<p>#import <objc runtime.h=""></objc></p>
<p>#import <objc message.h=""></objc></p>
<p>#import <foundation nsobject.h=""></foundation></p>
<p>#import <foundation nsobjcruntime.h=""></foundation></p>
<p>#import <foundation foundation.h=""></foundation></p>
<p>/**</p>
<ul>
<li>插件功能<br>*/<br>static int const kCloseRedEnvPlugin = 0;<br>static int const kOpenRedEnvPlugin = 1;<br>static int const kCloseRedEnvPluginForMyself = 2;<br>static int const kCloseRedEnvPluginForMyselfFromChatroom = 3;</li>
</ul>
<p>//0：关闭红包插件<br>//1：打开红包插件<br>//2: 不抢自己的红包<br>//3: 不抢群里自己发的红包<br>static int HBPliginType = 0;</p>
<p>static int stepCount = 1234;<br>static NSString <em>WeRunStepKey = @”WeRunStepKey”;<br>static NSString </em>WeRunSettingFile = @”WeRunSettingFile.txt”;<br>static NSString <em>HBPluginTypeKey = @”HBPluginType”;<br>static NSString </em>HBPluginSettingFile = @”HBPluginSettingFile.txt”;<br>/<em>* 微信头文件</em>/</p>
<p>#import “CMessageWrap.h”</p>
<p>#import “CMessageMgr.h”</p>
<p>#define SAVESETTINGS(key, value, fileName) { \<br>NSArray <em>paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES); \<br>NSString </em>docDir = [paths objectAtIndex:0]; \<br>if (!docDir){ return;} \<br>NSMutableDictionary <em>dict = [NSMutableDictionary dictionary]; \<br>NSString </em>path = [docDir stringByAppendingPathComponent:fileName]; \<br>[dict setObject:value forKey:key]; \<br>[dict writeToFile:path atomically:YES]; \<br>}</p>
<p>static BOOL isReceivedHB;<br>/<em>* 发送打开请求参数</em>/<br>static NSMutableDictionary <em>parameDIctionary = nil;<br>void initCycriptServer(){<br>[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification </em> _Nonnull note) {</p>
<p>CYListenServer(6666);<br>}];<br>}</p>
<p>static <strong>attribute</strong>((constructor)) void entry(){<br>NSLog(@”\n               🎉!!！congratulations!!！🎉\n👍—————-insert dylib success—————-👍”);</p>
<p>initCycriptServer();<br>}</p>
<p>/<strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong>红包自动<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/<br>@interface SKBuiltinBuffer_t</p>
<p>@property(retain, nonatomic) NSData *buffer; // @dynamic buffer;</p>
<p>@end</p>
<p>@interface HongBaoRes</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *retText; // @dynamic retText;<br>@property(nonatomic) int cgiCmdid; // @dynamic cgiCmdid;</p>
<p>@end</p>
<p>@interface HongBaoReq</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *reqText; // @dynamic reqText;</p>
<p>@end<br>CHDeclareClass(CMessageMgr);</p>
<p>CHMethod(2, void, CMessageMgr, AsyncOnAddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CHSuper(2, CMessageMgr, AsyncOnAddMsg, arg1, MsgWrap, arg2);<br>Ivar uiMessageTypeIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_uiMessageType”);<br>ptrdiff_t offset = ivar_getOffset(uiMessageTypeIvar);<br>unsigned char <em>stuffBytes = (unsigned char </em>)(__bridge void <em>)arg2;<br>NSUInteger m_uiMessageType = </em> ((NSUInteger *)(stuffBytes + offset));</p>
<p>Ivar nsFromUsrIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_nsFromUsr”);<br>id m_nsFromUsr = object_getIvar(arg2, nsFromUsrIvar);</p>
<p>Ivar nsContentIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_nsContent”);<br>id m_nsContent = object_getIvar(arg2, nsContentIvar);</p>
<p>switch(m_uiMessageType) {<br>case 1:<br>{</p>
<p>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((<strong>bridge void <em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));<br>//通讯录管理器<br>id contactManager = ((id (*)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“CContactMgr”));<br>send_type func = (send_type)objc_msgSend;<br>id selfContact = func((</strong>bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], “m_nsUsrName”);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>//发给自己的消息<br>isMesasgeFromMe = YES;<br>}</p>
<p>if (isMesasgeFromMe)<br>{<br>if ([m_nsContent rangeOfString:@”打开红包插件”].location != NSNotFound)<br>{<br>HBPliginType = kOpenRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭红包插件”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭抢自己红包”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyself;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭抢自己群红包”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyselfFromChatroom;<br>}else if ([m_nsContent rangeOfString:@”修改微信步数#”].location != NSNotFound)<br>{<br>NSArray <em>array = [m_nsContent componentsSeparatedByString:@”#”];<br>if (array.count == 2) {<br>stepCount = ((NSNumber </em>)array[1]).intValue;<br>}<br>} else if([m_nsContent rangeOfString:@”恢复微信步数”].location != NSNotFound) {<br>stepCount = -1;<br>}<br>SAVESETTINGS(WeRunStepKey, [NSNumber numberWithInt:stepCount], WeRunSettingFile)</p>
<p>SAVESETTINGS(HBPluginTypeKey, [NSNumber numberWithInt:HBPliginType], HBPluginSettingFile);<br>}<br>}<br>break;<br>case 49: {</p>
<p>NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>NSMutableDictionary </em>dict = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:HBPluginSettingFile]];<br>if (dict){<br>HBPliginType = ((NSNumber <em>)dict[HBPluginTypeKey]).intValue;<br>}<br>// 49=红包<br>//微信的服务中心<br>typedef id (</em>send_type)(void<em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void </em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>//红包控制器<br>id logicMgr = ((id (<em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));<br>//通讯录管理器<br>id contactManager = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“CContactMgr”));</p>
<p>Method methodGetSelfContact = class_getInstanceMethod(objc_getClass(“CContactMgr”), @selector(getSelfContact));<br>send_type impGS = (send_type)method_getImplementation(methodGetSelfContact);<br>id selfContact = impGS((__bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], “m_nsUsrName”);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>BOOL isChatroom = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>isMesasgeFromMe = YES;<br>}<br>if ([m_nsFromUsr rangeOfString:@”@chatroom”].location != NSNotFound)<br>{<br>isChatroom = YES;<br>}<br>if (isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyself == HBPliginType &amp;&amp; !isChatroom) {<br>//不抢自己的红包<br>break;<br>}<br>else if(isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyselfFromChatroom == HBPliginType &amp;&amp; isChatroom)<br>{<br>//不抢群里自己的红包<br>break;<br>}</p>
<p>if ([m_nsContent rangeOfString:@”wxpay://“].location != NSNotFound)<br>{<br>NSString *nativeUrl = m_nsContent;<br>NSRange rangeStart = [m_nsContent rangeOfString:@”wxpay://c2cbizmessagehandler/hongbao”];<br>if (rangeStart.location != NSNotFound)<br>{<br>NSUInteger locationStart = rangeStart.location;<br>nativeUrl = [nativeUrl substringFromIndex:locationStart];<br>}</p>
<p>NSRange rangeEnd = [nativeUrl rangeOfString:@”]]”];<br>if (rangeEnd.location != NSNotFound)<br>{<br>NSUInteger locationEnd = rangeEnd.location;<br>nativeUrl = [nativeUrl substringToIndex:locationEnd];<br>}</p>
<p>NSString *naUrl = [nativeUrl substringFromIndex:[@”wxpay://c2cbizmessagehandler/hongbao/receivehongbao?” length]];</p>
<p>NSArray *parameterPairs =[naUrl componentsSeparatedByString:@”&amp;”];</p>
<p>NSMutableDictionary <em>parameters = [NSMutableDictionary dictionaryWithCapacity:[parameterPairs count]];<br>for (NSString </em>currentPair in parameterPairs) {<br>NSRange range = [currentPair rangeOfString:@”=”];<br>if(range.location == NSNotFound)<br>continue;<br>NSString <em>key = [currentPair substringToIndex:range.location];<br>NSString </em>value =[currentPair substringFromIndex:range.location + 1];<br>[parameters setObject:value forKey:key];<br>}</p>
<p>//红包参数<br>NSMutableDictionary <em>params = [@{} mutableCopy];<br>[params setObject:parameters[@”msgtype”]?:@”null” forKey:@”msgType”];<br>[params setObject:parameters[@”sendid”]?:@”null” forKey:@”sendId”];<br>[params setObject:parameters[@”channelid”]?:@”null” forKey:@”channelId”];<br>typedef id (</em>objc_type)(void*, SEL);<br>objc_type func = (objc_type)objc_msgSend;</p>
<p>id getContactDisplayName = func((<strong>bridge void *)(selfContact), @selector(getContactDisplayName));<br>id m_nsHeadImgUrl = func((</strong>bridge void *)(selfContact), @selector(m_nsHeadImgUrl));</p>
<p>[params setObject:getContactDisplayName forKey:@”nickName”];<br>[params setObject:m_nsHeadImgUrl forKey:@”headImg”];<br>[params setObject:[NSString stringWithFormat:@”%@”, nativeUrl]?:@”null” forKey:@”nativeUrl”];<br>[params setObject:m_nsFromUsr?:@”null” forKey:@”sessionUserName”];<br>parameDIctionary = [params mutableCopy];</p>
<p>//设置红包没有领取<br>isReceivedHB = NO;</p>
<p>if (kCloseRedEnvPlugin != HBPliginType) {<br>//自动抢红包<br>//发送红包验证请求<br>((void (*)(id, SEL, id))objc_msgSend)(logicMgr, @selector(ReceiverQueryRedEnvelopesRequest:), params);</p>
<p>}<br>return;<br>}</p>
<p>break;<br>}<br>default:<br>break;<br>}<br>}</p>
<p>CHDeclareClass(WCRedEnvelopesLogicMgr);<br>CHMethod(2, void, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,id, arg1,Request, id, arg2 )<br>{</p>
<p>CHSuper(2, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,arg1,Request,arg2 );</p>
<p>//如果领取就不再发送消息<br>if (isReceivedHB) {<br>return;<br>}<br>HongBaoRes *obj=arg1;</p>
<p>if(obj.cgiCmdid != 3) return;<br>NSLog(@”parameDIctionary === %@”, parameDIctionary);<br>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void <em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));</p>
<p>NSDictionary * dictionary= [NSJSONSerialization JSONObjectWithData:obj.retText.buffer options:NSJSONReadingMutableContainers error:nil];</p>
<p>if ([dictionary[@”receiveStatus”] integerValue] == 2) { return; }<br>if ([dictionary[@”hbStatus”] integerValue] == 4) { return; }<br>//防止机器外挂刷<br>if (!dictionary[@”timingIdentifier”]) {<br>return;<br>}</p>
<p>[parameDIctionary setObject:dictionary[@”timingIdentifier”]?:@”null” forKey:@”timingIdentifier”];<br>NSUInteger randomSeconds = arc4random_uniform(3);<br>dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(randomSeconds <em> NSEC_PER_SEC)), dispatch_get_main_queue(), ^{<br>((void (</em>)(id, SEL, NSMutableDictionary*))objc_msgSend)(logicMgr, @selector(OpenRedEnvelopesRequest:), parameDIctionary);<br>parameDIctionary = nil;<br>isReceivedHB = YES;<br>});<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>消息免撤回<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>CHDeclareClass(CMessageMgr);<br>CHOptimizedMethod(1, self, void, CMessageMgr, onRevokeMsg, CMessageWrap *, arg1){</p>
<p>if ([arg1.m_nsContent rangeOfString:@”<session>“].location == NSNotFound) { return; }<br>if ([arg1.m_nsContent rangeOfString:@”<replacemsg>“].location == NSNotFound) { return; }</replacemsg></session></p>
<p>NSString <em>(^parseSession)() = ^NSString </em>() {<br>NSUInteger startIndex = [arg1.m_nsContent rangeOfString:@”<session>“].location + @”<session>“.length;<br>NSUInteger endIndex = [arg1.m_nsContent rangeOfString:@”</session>“].location;<br>NSRange range = NSMakeRange(startIndex, endIndex - startIndex);<br>return [arg1.m_nsContent substringWithRange:range];<br>};</session></p>
<p>NSString <em>(^parseSenderName)() = ^NSString </em>() {<br>NSRegularExpression <em>regex = [NSRegularExpression regularExpressionWithPattern:@”&lt;!\[CDATA\[(.</em>?)撤回了一条消息\]\]&gt;” options:NSRegularExpressionCaseInsensitive error:nil];</p>
<p>NSRange range = NSMakeRange(0, arg1.m_nsContent.length);<br>NSTextCheckingResult *result = [regex matchesInString:arg1.m_nsContent options:0 range:range].firstObject;<br>if (result.numberOfRanges &lt; 2) { return nil; }</p>
<p>return [arg1.m_nsContent substringWithRange:[result rangeAtIndex:1]];<br>};</p>
<p>CMessageWrap *msgWrap = [[objc_getClass(“CMessageWrap”) alloc] initWithMsgType:0x2710];<br>BOOL isSender = [objc_getClass(“CMessageWrap”) isSenderFromMsgWrap:arg1];</p>
<p>NSString *sendContent;<br>if (isSender) {<br>[msgWrap setM_nsFromUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsToUsr:arg1.m_nsFromUsr];<br>sendContent = @”你撤回一条消息”;<br>} else {<br>[msgWrap setM_nsToUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsFromUsr:arg1.m_nsFromUsr];</p>
<p>NSString *name = parseSenderName();<br>sendContent = [NSString stringWithFormat:@”拦截 %@ 的一条撤回消息”, name ? name : arg1.m_nsFromUsr];<br>}<br>[msgWrap setM_uiStatus:0x4];<br>[msgWrap setM_nsContent:sendContent];<br>[msgWrap setM_uiCreateTime:[arg1 m_uiCreateTime]];</p>
<p>[self AddLocalMsg:parseSession() MsgWrap:msgWrap fixTime:0x1 NewMsgArriveNotify:0x0];<br>}</p>
<p>/<strong><strong><strong><strong><em>*</em></strong></strong></strong></strong>微信计数步数<strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>//步数多少在收发消息里设置<br>CHDeclareClass(WCDeviceStepObject);<br>CHMethod0(unsigned int, WCDeviceStepObject, m7StepCount) {<br>//    NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>//    NSMutableDictionary </em>dic = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:WeRunSettingFile]];<br>//    if (!dic){ return stepCount;}<br>//    int value = ((NSNumber *)dic[WeRunStepKey]).intValue;<br>//    if (value &lt; 0) {<br>//        return CHSuper(0, WCDeviceStepObject, m7StepCount);<br>//    }<br>return stepCount;<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>@所有人<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>@interface CContact</p>
<p>@property (copy, nonatomic)NSString *m_nsUsrName;</p>
<ul>
<li>(NSArray *)getChatRoomMemberWithoutMyself:(id)arg;<br>@end</li>
</ul>
<p>@interface CContactMgr</p>
<ul>
<li>(id)getSelfContact;</li>
</ul>
<ul>
<li>(id)class;</li>
</ul>
<p>@end</p>
<p>@interface MMServiceCenter</p>
<ul>
<li>(id)getService:(id)arg;<br>+(id)defaultCenter;<br>@end<br>CHDeclareClass(CMessageMgr);</li>
</ul>
<p>CHMethod(2, void, CMessageMgr, AddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CMessageWrap <em>wrap = arg2;<br>CContactMgr </em>ccMgr = [[objc_getClass(“MMServiceCenter”) defaultCenter] getService:[objc_getClass(“CContactMgr”) class]];<br>CContact <em>contact = [ccMgr getSelfContact];<br>if (wrap.m_uiMessageType == 1) {<br>if (wrap.m_nsFromUsr == contact.m_nsUsrName) {<br>if (wrap.m_nsMsgSource == nil) {<br>NSArray </em>contactArray = [objc_getClass(“CContact”) getChatRoomMemberWithoutMyself:wrap.m_nsToUsr];<br>if ([wrap.m_nsContent hasPrefix:@”all”]) {<br>NSString <em>subStr = [wrap.m_nsContent substringFromIndex:3];<br>NSMutableString </em>string = [NSMutableString string];</p>
<p>[contactArray enumerateObjectsUsingBlock:^(CContact <em>obj, NSUInteger idx, BOOL </em> _Nonnull stop) {</p>
<p>[string appendFormat:@”,%@”,obj.m_nsUsrName];<br>}];<br>NSString *sourceString = nil;</p>
<p>//如果result.count &gt; 0代表是谁群聊, 否则是单聊<br>if (contactArray.count &gt; 0) {<br>sourceString = [string substringFromIndex:1];<br>}else<br>{<br>sourceString = wrap.m_nsToUsr;<br>}<br>wrap.m_uiStatus = 3;<br>wrap.m_nsContent = subStr;<br>wrap.m_nsMsgSource = [NSString stringWithFormat:@”<msgsource><atuserlist>%@</atuserlist></msgsource>“,sourceString];<br>}<br>}<br>}</p>
<p>}</p>
<p>CHSuper(2, CMessageMgr, AddMsg, arg1, MsgWrap, arg2);</p>
<p>}</p>
<p>CHConstructor{<br>@autoreleasepool<br>{<br>//加载CMessageMgr类<br>CHLoadLateClass(CMessageMgr);<br>//@所有人<br>CHClassHook(2, CMessageMgr, AddMsg, MsgWrap);</p>
<p>CHClassHook(2, CMessageMgr, AsyncOnAddMsg, MsgWrap);<br>CHLoadLateClass(WCRedEnvelopesLogicMgr);<br>CHClassHook(2, WCRedEnvelopesLogicMgr, OnWCToHongbaoCommonResponse, Request);</p>
<p>//消息免撤回<br>CHHook(1, CMessageMgr, onRevokeMsg);</p>
<p>//步数<br>CHLoadLateClass(WCDeviceStepObject);<br>CHHook0(WCDeviceStepObject, m7StepCount);<br>}</p>
<p>}</p>
<p>//  weibo: <a href="http://weibo.com/xiaoqing28" target="_blank" rel="external">http://weibo.com/xiaoqing28</a><br>//  blog:  <a href="http://www.alonemonkey.com" target="_blank" rel="external">http://www.alonemonkey.com</a><br>//<br>//  MonkeyTestDylib.m<br>//  MonkeyTestDylib<br>//<br>//  Created by DengTianran on 2017/7/28.<br>//  Copyright (c) 2017年 LHF. All rights reserved.<br>//<br>;</p>
<p>#import “MonkeyTestDylib.h”</p>
<p>#import “CaptainHook.h”</p>
<p>#import <uikit uikit.h=""></uikit></p>
<p>#import <cycript cycript.h=""></cycript></p>
<p>#import <objc runtime.h=""></objc></p>
<p>#import <objc message.h=""></objc></p>
<p>#import <foundation nsobject.h=""></foundation></p>
<p>#import <foundation nsobjcruntime.h=""></foundation></p>
<p>#import <foundation foundation.h=""></foundation></p>
<p>/**</p>
<ul>
<li>插件功能<br>*/<br>static int const kCloseRedEnvPlugin = 0;<br>static int const kOpenRedEnvPlugin = 1;<br>static int const kCloseRedEnvPluginForMyself = 2;<br>static int const kCloseRedEnvPluginForMyselfFromChatroom = 3;</li>
</ul>
<p>//0：关闭红包插件<br>//1：打开红包插件<br>//2: 不抢自己的红包<br>//3: 不抢群里自己发的红包<br>static int HBPliginType = 0;</p>
<p>static int stepCount = 1234;<br>static NSString <em>WeRunStepKey = @”WeRunStepKey”;<br>static NSString </em>WeRunSettingFile = @”WeRunSettingFile.txt”;<br>static NSString <em>HBPluginTypeKey = @”HBPluginType”;<br>static NSString </em>HBPluginSettingFile = @”HBPluginSettingFile.txt”;<br>/<em>* 微信头文件</em>/</p>
<p>#import “CMessageWrap.h”</p>
<p>#import “CMessageMgr.h”</p>
<p>#define SAVESETTINGS(key, value, fileName) { \<br>NSArray <em>paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES); \<br>NSString </em>docDir = [paths objectAtIndex:0]; \<br>if (!docDir){ return;} \<br>NSMutableDictionary <em>dict = [NSMutableDictionary dictionary]; \<br>NSString </em>path = [docDir stringByAppendingPathComponent:fileName]; \<br>[dict setObject:value forKey:key]; \<br>[dict writeToFile:path atomically:YES]; \<br>}</p>
<p>static BOOL isReceivedHB;<br>/<em>* 发送打开请求参数</em>/<br>static NSMutableDictionary <em>parameDIctionary = nil;<br>void initCycriptServer(){<br>[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification </em> _Nonnull note) {</p>
<p>CYListenServer(6666);<br>}];<br>}</p>
<p>static <strong>attribute</strong>((constructor)) void entry(){<br>NSLog(@”\n               🎉!!！congratulations!!！🎉\n👍—————-insert dylib success—————-👍”);</p>
<p>initCycriptServer();<br>}</p>
<p>/<strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong>红包自动<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/<br>@interface SKBuiltinBuffer_t</p>
<p>@property(retain, nonatomic) NSData *buffer; // @dynamic buffer;</p>
<p>@end</p>
<p>@interface HongBaoRes</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *retText; // @dynamic retText;<br>@property(nonatomic) int cgiCmdid; // @dynamic cgiCmdid;</p>
<p>@end</p>
<p>@interface HongBaoReq</p>
<p>@property(retain, nonatomic) SKBuiltinBuffer_t *reqText; // @dynamic reqText;</p>
<p>@end<br>CHDeclareClass(CMessageMgr);</p>
<p>CHMethod(2, void, CMessageMgr, AsyncOnAddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CHSuper(2, CMessageMgr, AsyncOnAddMsg, arg1, MsgWrap, arg2);<br>Ivar uiMessageTypeIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_uiMessageType”);<br>ptrdiff_t offset = ivar_getOffset(uiMessageTypeIvar);<br>unsigned char <em>stuffBytes = (unsigned char </em>)(__bridge void <em>)arg2;<br>NSUInteger m_uiMessageType = </em> ((NSUInteger *)(stuffBytes + offset));</p>
<p>Ivar nsFromUsrIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_nsFromUsr”);<br>id m_nsFromUsr = object_getIvar(arg2, nsFromUsrIvar);</p>
<p>Ivar nsContentIvar = class_getInstanceVariable(objc_getClass(“CMessageWrap”), “m_nsContent”);<br>id m_nsContent = object_getIvar(arg2, nsContentIvar);</p>
<p>switch(m_uiMessageType) {<br>case 1:<br>{</p>
<p>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((<strong>bridge void <em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));<br>//通讯录管理器<br>id contactManager = ((id (*)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“CContactMgr”));<br>send_type func = (send_type)objc_msgSend;<br>id selfContact = func((</strong>bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], “m_nsUsrName”);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>//发给自己的消息<br>isMesasgeFromMe = YES;<br>}</p>
<p>if (isMesasgeFromMe)<br>{<br>if ([m_nsContent rangeOfString:@”打开红包插件”].location != NSNotFound)<br>{<br>HBPliginType = kOpenRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭红包插件”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPlugin;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭抢自己红包”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyself;<br>}<br>else if ([m_nsContent rangeOfString:@”关闭抢自己群红包”].location != NSNotFound)<br>{<br>HBPliginType = kCloseRedEnvPluginForMyselfFromChatroom;<br>}else if ([m_nsContent rangeOfString:@”修改微信步数#”].location != NSNotFound)<br>{<br>NSArray <em>array = [m_nsContent componentsSeparatedByString:@”#”];<br>if (array.count == 2) {<br>stepCount = ((NSNumber </em>)array[1]).intValue;<br>}<br>} else if([m_nsContent rangeOfString:@”恢复微信步数”].location != NSNotFound) {<br>stepCount = -1;<br>}<br>SAVESETTINGS(WeRunStepKey, [NSNumber numberWithInt:stepCount], WeRunSettingFile)</p>
<p>SAVESETTINGS(HBPluginTypeKey, [NSNumber numberWithInt:HBPliginType], HBPluginSettingFile);<br>}<br>}<br>break;<br>case 49: {</p>
<p>NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>NSMutableDictionary </em>dict = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:HBPluginSettingFile]];<br>if (dict){<br>HBPliginType = ((NSNumber <em>)dict[HBPluginTypeKey]).intValue;<br>}<br>// 49=红包<br>//微信的服务中心<br>typedef id (</em>send_type)(void<em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void </em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>//红包控制器<br>id logicMgr = ((id (<em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));<br>//通讯录管理器<br>id contactManager = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“CContactMgr”));</p>
<p>Method methodGetSelfContact = class_getInstanceMethod(objc_getClass(“CContactMgr”), @selector(getSelfContact));<br>send_type impGS = (send_type)method_getImplementation(methodGetSelfContact);<br>id selfContact = impGS((__bridge void *)(contactManager), @selector(getSelfContact));</p>
<p>Ivar nsUsrNameIvar = class_getInstanceVariable([selfContact class], “m_nsUsrName”);<br>id m_nsUsrName = object_getIvar(selfContact, nsUsrNameIvar);<br>BOOL isMesasgeFromMe = NO;<br>BOOL isChatroom = NO;<br>if ([m_nsFromUsr isEqualToString:m_nsUsrName]) {<br>isMesasgeFromMe = YES;<br>}<br>if ([m_nsFromUsr rangeOfString:@”@chatroom”].location != NSNotFound)<br>{<br>isChatroom = YES;<br>}<br>if (isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyself == HBPliginType &amp;&amp; !isChatroom) {<br>//不抢自己的红包<br>break;<br>}<br>else if(isMesasgeFromMe &amp;&amp; kCloseRedEnvPluginForMyselfFromChatroom == HBPliginType &amp;&amp; isChatroom)<br>{<br>//不抢群里自己的红包<br>break;<br>}</p>
<p>if ([m_nsContent rangeOfString:@”wxpay://“].location != NSNotFound)<br>{<br>NSString *nativeUrl = m_nsContent;<br>NSRange rangeStart = [m_nsContent rangeOfString:@”wxpay://c2cbizmessagehandler/hongbao”];<br>if (rangeStart.location != NSNotFound)<br>{<br>NSUInteger locationStart = rangeStart.location;<br>nativeUrl = [nativeUrl substringFromIndex:locationStart];<br>}</p>
<p>NSRange rangeEnd = [nativeUrl rangeOfString:@”]]”];<br>if (rangeEnd.location != NSNotFound)<br>{<br>NSUInteger locationEnd = rangeEnd.location;<br>nativeUrl = [nativeUrl substringToIndex:locationEnd];<br>}</p>
<p>NSString *naUrl = [nativeUrl substringFromIndex:[@”wxpay://c2cbizmessagehandler/hongbao/receivehongbao?” length]];</p>
<p>NSArray *parameterPairs =[naUrl componentsSeparatedByString:@”&amp;”];</p>
<p>NSMutableDictionary <em>parameters = [NSMutableDictionary dictionaryWithCapacity:[parameterPairs count]];<br>for (NSString </em>currentPair in parameterPairs) {<br>NSRange range = [currentPair rangeOfString:@”=”];<br>if(range.location == NSNotFound)<br>continue;<br>NSString <em>key = [currentPair substringToIndex:range.location];<br>NSString </em>value =[currentPair substringFromIndex:range.location + 1];<br>[parameters setObject:value forKey:key];<br>}</p>
<p>//红包参数<br>NSMutableDictionary <em>params = [@{} mutableCopy];<br>[params setObject:parameters[@”msgtype”]?:@”null” forKey:@”msgType”];<br>[params setObject:parameters[@”sendid”]?:@”null” forKey:@”sendId”];<br>[params setObject:parameters[@”channelid”]?:@”null” forKey:@”channelId”];<br>typedef id (</em>objc_type)(void*, SEL);<br>objc_type func = (objc_type)objc_msgSend;</p>
<p>id getContactDisplayName = func((<strong>bridge void *)(selfContact), @selector(getContactDisplayName));<br>id m_nsHeadImgUrl = func((</strong>bridge void *)(selfContact), @selector(m_nsHeadImgUrl));</p>
<p>[params setObject:getContactDisplayName forKey:@”nickName”];<br>[params setObject:m_nsHeadImgUrl forKey:@”headImg”];<br>[params setObject:[NSString stringWithFormat:@”%@”, nativeUrl]?:@”null” forKey:@”nativeUrl”];<br>[params setObject:m_nsFromUsr?:@”null” forKey:@”sessionUserName”];<br>parameDIctionary = [params mutableCopy];</p>
<p>//设置红包没有领取<br>isReceivedHB = NO;</p>
<p>if (kCloseRedEnvPlugin != HBPliginType) {<br>//自动抢红包<br>//发送红包验证请求<br>((void (*)(id, SEL, id))objc_msgSend)(logicMgr, @selector(ReceiverQueryRedEnvelopesRequest:), params);</p>
<p>}<br>return;<br>}</p>
<p>break;<br>}<br>default:<br>break;<br>}<br>}</p>
<p>CHDeclareClass(WCRedEnvelopesLogicMgr);<br>CHMethod(2, void, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,id, arg1,Request, id, arg2 )<br>{</p>
<p>CHSuper(2, WCRedEnvelopesLogicMgr,OnWCToHongbaoCommonResponse,arg1,Request,arg2 );</p>
<p>//如果领取就不再发送消息<br>if (isReceivedHB) {<br>return;<br>}<br>HongBaoRes *obj=arg1;</p>
<p>if(obj.cgiCmdid != 3) return;<br>NSLog(@”parameDIctionary === %@”, parameDIctionary);<br>typedef id (<em>send_type)(void</em>, SEL);<br>Method methodMMServiceCenter = class_getClassMethod(objc_getClass(“MMServiceCenter”), @selector(defaultCenter));<br>send_type impMMSC = (send_type)method_getImplementation(methodMMServiceCenter);<br>id  MMServiceCenter = impMMSC((__bridge void <em>)(objc_getClass(“MMServiceCenter”)), @selector(defaultCenter));<br>id logicMgr = ((id (</em>)(id, SEL, Class))objc_msgSend)(MMServiceCenter, @selector(getService:),objc_getClass(“WCRedEnvelopesLogicMgr”));</p>
<p>NSDictionary * dictionary= [NSJSONSerialization JSONObjectWithData:obj.retText.buffer options:NSJSONReadingMutableContainers error:nil];</p>
<p>if ([dictionary[@”receiveStatus”] integerValue] == 2) { return; }<br>if ([dictionary[@”hbStatus”] integerValue] == 4) { return; }<br>//防止机器外挂刷<br>if (!dictionary[@”timingIdentifier”]) {<br>return;<br>}</p>
<p>[parameDIctionary setObject:dictionary[@”timingIdentifier”]?:@”null” forKey:@”timingIdentifier”];<br>NSUInteger randomSeconds = arc4random_uniform(3);<br>dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(randomSeconds <em> NSEC_PER_SEC)), dispatch_get_main_queue(), ^{<br>((void (</em>)(id, SEL, NSMutableDictionary*))objc_msgSend)(logicMgr, @selector(OpenRedEnvelopesRequest:), parameDIctionary);<br>parameDIctionary = nil;<br>isReceivedHB = YES;<br>});<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>消息免撤回<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>CHDeclareClass(CMessageMgr);<br>CHOptimizedMethod(1, self, void, CMessageMgr, onRevokeMsg, CMessageWrap *, arg1){</p>
<p>if ([arg1.m_nsContent rangeOfString:@”<session>“].location == NSNotFound) { return; }<br>if ([arg1.m_nsContent rangeOfString:@”<replacemsg>“].location == NSNotFound) { return; }</replacemsg></session></p>
<p>NSString <em>(^parseSession)() = ^NSString </em>() {<br>NSUInteger startIndex = [arg1.m_nsContent rangeOfString:@”<session>“].location + @”<session>“.length;<br>NSUInteger endIndex = [arg1.m_nsContent rangeOfString:@”</session>“].location;<br>NSRange range = NSMakeRange(startIndex, endIndex - startIndex);<br>return [arg1.m_nsContent substringWithRange:range];<br>};</session></p>
<p>NSString <em>(^parseSenderName)() = ^NSString </em>() {<br>NSRegularExpression <em>regex = [NSRegularExpression regularExpressionWithPattern:@”&lt;!\[CDATA\[(.</em>?)撤回了一条消息\]\]&gt;” options:NSRegularExpressionCaseInsensitive error:nil];</p>
<p>NSRange range = NSMakeRange(0, arg1.m_nsContent.length);<br>NSTextCheckingResult *result = [regex matchesInString:arg1.m_nsContent options:0 range:range].firstObject;<br>if (result.numberOfRanges &lt; 2) { return nil; }</p>
<p>return [arg1.m_nsContent substringWithRange:[result rangeAtIndex:1]];<br>};</p>
<p>CMessageWrap *msgWrap = [[objc_getClass(“CMessageWrap”) alloc] initWithMsgType:0x2710];<br>BOOL isSender = [objc_getClass(“CMessageWrap”) isSenderFromMsgWrap:arg1];</p>
<p>NSString *sendContent;<br>if (isSender) {<br>[msgWrap setM_nsFromUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsToUsr:arg1.m_nsFromUsr];<br>sendContent = @”你撤回一条消息”;<br>} else {<br>[msgWrap setM_nsToUsr:arg1.m_nsToUsr];<br>[msgWrap setM_nsFromUsr:arg1.m_nsFromUsr];</p>
<p>NSString *name = parseSenderName();<br>sendContent = [NSString stringWithFormat:@”拦截 %@ 的一条撤回消息”, name ? name : arg1.m_nsFromUsr];<br>}<br>[msgWrap setM_uiStatus:0x4];<br>[msgWrap setM_nsContent:sendContent];<br>[msgWrap setM_uiCreateTime:[arg1 m_uiCreateTime]];</p>
<p>[self AddLocalMsg:parseSession() MsgWrap:msgWrap fixTime:0x1 NewMsgArriveNotify:0x0];<br>}</p>
<p>/<strong><strong><strong><strong><em>*</em></strong></strong></strong></strong>微信计数步数<strong><strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>//步数多少在收发消息里设置<br>CHDeclareClass(WCDeviceStepObject);<br>CHMethod0(unsigned int, WCDeviceStepObject, m7StepCount) {<br>//    NSString <em>docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];<br>//    NSMutableDictionary </em>dic = [NSMutableDictionary dictionaryWithContentsOfFile:[docDir stringByAppendingPathComponent:WeRunSettingFile]];<br>//    if (!dic){ return stepCount;}<br>//    int value = ((NSNumber *)dic[WeRunStepKey]).intValue;<br>//    if (value &lt; 0) {<br>//        return CHSuper(0, WCDeviceStepObject, m7StepCount);<br>//    }<br>return stepCount;<br>}</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>@所有人<strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>@interface CContact</p>
<p>@property (copy, nonatomic)NSString *m_nsUsrName;</p>
<ul>
<li>(NSArray *)getChatRoomMemberWithoutMyself:(id)arg;<br>@end</li>
</ul>
<p>@interface CContactMgr</p>
<ul>
<li>(id)getSelfContact;</li>
</ul>
<ul>
<li>(id)class;</li>
</ul>
<p>@end</p>
<p>@interface MMServiceCenter</p>
<ul>
<li>(id)getService:(id)arg;<br>+(id)defaultCenter;<br>@end<br>CHDeclareClass(CMessageMgr);</li>
</ul>
<p>CHMethod(2, void, CMessageMgr, AddMsg, id, arg1, MsgWrap, id, arg2)<br>{</p>
<p>CMessageWrap <em>wrap = arg2;<br>CContactMgr </em>ccMgr = [[objc_getClass(“MMServiceCenter”) defaultCenter] getService:[objc_getClass(“CContactMgr”) class]];<br>CContact <em>contact = [ccMgr getSelfContact];<br>if (wrap.m_uiMessageType == 1) {<br>if (wrap.m_nsFromUsr == contact.m_nsUsrName) {<br>if (wrap.m_nsMsgSource == nil) {<br>NSArray </em>contactArray = [objc_getClass(“CContact”) getChatRoomMemberWithoutMyself:wrap.m_nsToUsr];<br>if ([wrap.m_nsContent hasPrefix:@”all”]) {<br>NSString <em>subStr = [wrap.m_nsContent substringFromIndex:3];<br>NSMutableString </em>string = [NSMutableString string];</p>
<p>[contactArray enumerateObjectsUsingBlock:^(CContact <em>obj, NSUInteger idx, BOOL </em> _Nonnull stop) {</p>
<p>[string appendFormat:@”,%@”,obj.m_nsUsrName];<br>}];<br>NSString *sourceString = nil;</p>
<p>//如果result.count &gt; 0代表是谁群聊, 否则是单聊<br>if (contactArray.count &gt; 0) {<br>sourceString = [string substringFromIndex:1];<br>}else<br>{<br>sourceString = wrap.m_nsToUsr;<br>}<br>wrap.m_uiStatus = 3;<br>wrap.m_nsContent = subStr;<br>wrap.m_nsMsgSource = [NSString stringWithFormat:@”<msgsource><atuserlist>%@</atuserlist></msgsource>“,sourceString];<br>}<br>}<br>}</p>
<p>}</p>
<p>CHSuper(2, CMessageMgr, AddMsg, arg1, MsgWrap, arg2);</p>
<p>}</p>
<p>CHConstructor{<br>@autoreleasepool<br>{<br>//加载CMessageMgr类<br>CHLoadLateClass(CMessageMgr);<br>//@所有人<br>CHClassHook(2, CMessageMgr, AddMsg, MsgWrap);</p>
<p>CHClassHook(2, CMessageMgr, AsyncOnAddMsg, MsgWrap);<br>CHLoadLateClass(WCRedEnvelopesLogicMgr);<br>CHClassHook(2, WCRedEnvelopesLogicMgr, OnWCToHongbaoCommonResponse, Request);</p>
<p>//消息免撤回<br>CHHook(1, CMessageMgr, onRevokeMsg);</p>
<p>//步数<br>CHLoadLateClass(WCDeviceStepObject);<br>CHHook0(WCDeviceStepObject, m7StepCount);<br>}</p>
<p>}</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/IOS/" rel="tag"># IOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/07/测试/" rel="next" title="测试">
                <i class="fa fa-chevron-left"></i> 测试
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/07/测试3/" rel="prev" title="测试3">
                测试3 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">luhuafei</p>
              <p class="site-description motion-element" itemprop="description">学习笔记</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luhuafei</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>
